

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>10. User-Defined Functions &mdash; MFiX 25.2.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=bc05c87d" />
      <link rel="stylesheet" type="text/css" href="../_static/mfix.css?v=31071079" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=b06fed7c"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="11. Running MFiX on Joule" href="../mfix_on_joule.html" />
    <link rel="prev" title="9. Running interactive solver job in queue" href="../queue.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >


          
          
          <a href="../index.html">
            
              <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

<br/>
<div class="version-display">
  <span class="version-text">Version: 25.2</span>
</div>



        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about.html">1. About MFiX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">2. Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">3. Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../model_setup/index.html">4. Model guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../solver/build.html">5. Building the solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../solver/run.html">6. Running the solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/index.html">7. Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_interface_reference.html">8. GUI reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../queue.html">9. Running interactive solver job in queue</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">10. User-Defined Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mfix_on_joule.html">11. Running MFiX on Joule</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">12. Keyword reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">13. Frequently asked questions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MFiX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">10. </span>User-Defined Functions</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/reference/user_defined_functions.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="user-defined-functions">
<span id="id1"></span><h1><span class="section-number">10. </span>User-Defined Functions<a class="headerlink" href="#user-defined-functions" title="Link to this heading">Â¶</a></h1>
<p>User-Defined Functions (UDFs) are source files in the same directory as the
project file that define code that is called by specific locations in the main
MFiX code. UDFs are used to customize the behavior of MFiX. One common usage is
for creating user-specific output files. In many cases, creating a personalized
UDF is preferable to using postmfix.</p>
<p>Because MFiX is open source, users may modify any <code class="docutils literal notranslate"><span class="pre">*.f</span></code> or <code class="docutils literal notranslate"><span class="pre">*.inc</span></code> file
under the model directory.
To modify a file, first copy it from the model directory into the run directory. All
modifications should be made to the file in the run directory. For example, list
the contents of the <code class="docutils literal notranslate"><span class="pre">adiabaticFlame</span></code> test case located in the <code class="docutils literal notranslate"><span class="pre">legacy_tests</span></code>
directory.
Legacy tests can be found by downloading the source tarball. They are meant to provide representative setups for older versions of MFiX (before the launch of the GUI), and are not guaranteed to run with the latest version of MFiX.</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>tutorials/tfm/silane_pyrolysis_2d
<span class="gp">$ </span>ls
<span class="go">SP2D.mfx    usr0.f      usr1.f      usr_mod.f   usr_rates.f</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">SP2D.mfx</span></code> file is the project file, and the <code class="docutils literal notranslate"><span class="pre">usr*.f</span></code> files are the UDFs used by this project.
simulation. After running <code class="docutils literal notranslate"><span class="pre">build_mfixsolver</span></code>, a re-examination of the same folder reveals:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>build_mfixsolver
<span class="go">...long output...</span>
<span class="gp">$ </span>ls
<span class="go">Makefile    build       mfixsolver  usr.mod     usr0.f      usr1.d      usr1.o      usr_mod.f   usr_rates.d usr_rates.o</span>
<span class="go">SP2D.mfx    lib         species.inc usr0.d      usr0.o      usr1.f      usr_mod.d   usr_mod.o   usr_rates.f</span>
</pre></div>
</div>
<p>Each UDF has a corresponding dependency (<code class="docutils literal notranslate"><span class="pre">.d</span></code>) file and object (<code class="docutils literal notranslate"><span class="pre">.o</span></code>) file.</p>
<p>If a project has a <code class="docutils literal notranslate"><span class="pre">usr_rates.f</span></code> UDF, an additional <code class="docutils literal notranslate"><span class="pre">species.inc</span></code> file is generated from
the project file during the reaction preprocessing step of the build.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">.d</span></code> and <code class="docutils literal notranslate"><span class="pre">.o</span></code> files are intermediate dependency and object files that are
created and linked with the executable, mfix.</p>
<p>The following is a list of MFIX files that are usually modified to include user
defined scalars, user defined drag models, and chemical reactions, physical
properties, and source terms for the governing equations:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>File name:</p></td>
<td><p>Usage</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">scalar_prop.f</span></code></p></td>
<td><p>Properties and source terms in scalar transport equations</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">usr_drag.f</span></code></p></td>
<td><p>User-defined drag function</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">usr_rates.f</span></code></p></td>
<td><p>Chemical reaction rates</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">usr_rates_des.f</span></code></p></td>
<td><p>DES chemical reaction rates</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">usr_properties.f</span></code></p></td>
<td><p>Physical properties (density, specific heat, etc.)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">usr_sources.f</span></code></p></td>
<td><p>Governing equation source terms</p></td>
</tr>
</tbody>
</table>
<p>The following routines are used for writing user-defined output:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>File name:</p></td>
<td><p>Usage</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">write_usr0.f</span></code></p></td>
<td><p>Called once at the start of a run, for opening output files.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">write_usr1.f</span></code></p></td>
<td><p>Called at intervals defined by USR_DT.</p></td>
</tr>
</tbody>
</table>
<p>To activate the calls to the following routines, make sure the âEnable
user-defined subroutinesâ checkbox is checked in the Model pane.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>File name:</p></th>
<th class="head"><p>Usage</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">usr0.f</span></code></p></td>
<td><p>Subroutine that is called once every run, just before the time-loop begins.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">usr1.f</span></code></p></td>
<td><p>Subroutine that is called once every timestep.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">usr2.f</span></code></p></td>
<td><p>Subroutine that is called once every iteration.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">usr3.f</span></code></p></td>
<td><p>Subroutine that is called once every run, after the time-loop ends.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">usrnlst.inc</span></code></p></td>
<td><p>List of user-defined keywords. These may be used to enter data through the project file.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">usr_init_namelist.f</span></code></p></td>
<td><p>Initialize user-defined keywords.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">usr_mod.f</span></code></p></td>
<td><p>User-defined module. Include <code class="docutils literal notranslate"><span class="pre">USE</span> <span class="pre">usr</span></code> to use userdefined variables in this module.
If allocatable arrays are defined in this module, allocate them in usr0.f. [1]</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">usr0_des.f</span></code></p></td>
<td><p>Subroutine called before entering the DES time loop. [1]</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">usr1_des.f</span></code></p></td>
<td><p>Subroutine called every DES timestep after calculating DES source terms but before source terms are applied to the particles.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">usr2_des.f</span></code></p></td>
<td><p>Subroutine called every DES timestep after source terms are applied to the particles.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">usr3_des.f</span></code></p></td>
<td><p>Subroutine that is called after completing the DES time loop.</p></td>
</tr>
</tbody>
</table>
<p>The following figures illustrate the local call structure for UDFs, for typical TFM/PIC and DEM runs:</p>
<figure class="align-center" id="id2">
<img alt="UDF call graph" src="../_images/udf_callgraph.png" />
<figcaption>
<p><span class="caption-number">Figure 10.1 </span><span class="caption-text">Call Graph for UDF Subroutines</span><a class="headerlink" href="#id2" title="Link to this image">Â¶</a></p>
</figcaption>
</figure>
<p>DES User-defined subroutines call structure:</p>
<figure class="align-center" id="id3">
<img alt="UDF DES call graph" src="../_images/udf_des_callgraph.png" />
<figcaption>
<p><span class="caption-number">Figure 10.2 </span><span class="caption-text">Call Graph for UDF DES Subroutines</span><a class="headerlink" href="#id3" title="Link to this image">Â¶</a></p>
</figcaption>
</figure>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">USR_</span></code> keywords do not have any explicit behavior. They are only basic
input mechanisms to interact with user-defined functions. For example,
specifying <code class="docutils literal notranslate"><span class="pre">USR_X_w</span></code> does not result in the associated <code class="docutils literal notranslate"><span class="pre">I</span></code> index, <code class="docutils literal notranslate"><span class="pre">USR_I_W</span></code>
being calculated. It is up to the user to ensure that all user hooks are fully
specified.</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../queue.html" class="btn btn-neutral float-left" title="9. Running interactive solver job in queue" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../mfix_on_joule.html" class="btn btn-neutral float-right" title="11. Running MFiX on Joule" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, NETL Multiphase Flow Science Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>